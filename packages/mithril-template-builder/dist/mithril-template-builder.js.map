{"version":3,"file":"mithril-template-builder.js","sources":["../src/index.js"],"sourcesContent":["// @ts-check\n\n/**\n * @typedef {{tag: string, attrs: object, children: Array<Vnode>}} Vnode\n */\n\n/**\n * @type {RegExp} ENTITY_REGEX\n */\nconst ENTITY_REGEX = /(&#?\\w+;)/;\n\nconst svgCaseSensitiveTagNames = [\"altGlyph\", \"altGlyphDef\", \"altGlyphItem\", \"animateColor\", \"animateMotion\", \"animateTransform\", \"clipPath\", \"feBlend\", \"feColorMatrix\", \"feComponentTransfer\", \"feComposite\", \"feConvolveMatrix\", \"feDiffuseLighting\", \"feDisplacementMap\", \"feDistantLight\", \"feFlood\", \"feFuncA\", \"feFuncB\", \"feFuncG\", \"feFuncR\", \"feGaussianBlur\", \"feImage\", \"feMerge\", \"feMergeNode\", \"feMorphology\", \"feOffset\", \"fePointLight\", \"feSpecularLighting\", \"feSpotLight\", \"feTile\", \"feTurbulence\", \"foreignObject\", \"glyphRef\", \"linearGradient\", \"radialGradient\", \"textPath\"];\n\nconst svgCaseSensitiveTagNamesMap = {};\nsvgCaseSensitiveTagNames.forEach((term) => {\n  svgCaseSensitiveTagNamesMap[term.toLowerCase()] = term;\n});\n\n/**\n * @param {Array} list \n * @param {function} f \n */\nfunction each(list, f) {\n  for (let i = 0; i < list.length; i++) {\n    f(list[i], i);\n  }\n}\n\n/**\n * @param {string} markup \n * @returns {Array<ChildNode>}\n */\nfunction createFragment(markup) {\n  // escape HTML entities, to be resolved in addVirtualString\n  markup = markup.replace(/&/g, \"&amp;\");\n  if (markup.indexOf(\"<!doctype\") >= 0) {\n    return [\n      new DOMParser()\n        .parseFromString(markup, \"text/html\")\n        .childNodes[1]\n    ];\n  }\n  const container = document.createElement(\"div\");\n  container.insertAdjacentHTML(\"beforeend\", markup);\n  return [...container.childNodes];\n}\n\n/**\n * @param {Array<Node>|Array<ChildNode>} fragment \n * @returns {Array<Vnode>}\n */\nfunction createVirtual(fragment) {\n  const list = [];\n\n  each(fragment, function(el) {\n    if (el.nodeType === 3) {\n      list.push(el.nodeValue);\n    } else if (el.nodeType === 1) {\n      const attrs = {};\n      each(el.attributes, function(attr) {\n        attrs[attr.name] = attr.value;\n      });\n\n      const tag = el.nodeName.toLowerCase();\n      const caseTag = svgCaseSensitiveTagNamesMap[tag] ? svgCaseSensitiveTagNamesMap[tag] : tag;\n\n      list.push({\n        tag: caseTag,\n        attrs,\n        children: createVirtual(el.childNodes)\n      });\n    }\n  });\n  return list;\n}\n\n/**\n * \n * @param {Array<Vnode>} virtual \n */\nfunction TemplateBuilder(virtual) {\n  this.virtual = virtual;\n  this.children = []; // each child is an object with attributes: node, children, content\n}\n\nTemplateBuilder.prototype = {\n  addVirtualString: function(el) {\n    const content = el.replace(/([\"\\r\\n])/g, \"\\\\$1\");\n    // handle HTML entities\n    const contentWithEntities = content.split(ENTITY_REGEX);\n    if (contentWithEntities.length > 1) {\n      contentWithEntities.forEach((part) => {\n        if (part.match(ENTITY_REGEX)) {\n          this.children.push({\n            content: `m.trust(\"${part}\")`\n          });\n        } else if (part) {\n          this.children.push({\n            content: `\"${part}\"`\n          });\n        }\n      });\n    } else {\n      this.children.push({\n        content: `\"${content}\"`\n      });\n    }\n  },\n\n  /**\n   * @param {object} vnode \n   */\n  addVirtualAttrs: function(vnode) {\n    let virtual = vnode.tag === \"div\" ? \"\" : vnode.tag;\n\n    if (vnode.attrs.class) {\n      let attrs = vnode.attrs.class.replace(/\\s+/g, \".\");\n      virtual += `.${attrs}`;\n      vnode.attrs.class = undefined;\n    }\n\n    each(Object.keys(vnode.attrs).sort(), function(attrName) {\n      if (attrName === \"style\") return;\n      if (vnode.attrs[attrName] === undefined) return;\n      let attrs = vnode.attrs[attrName];\n      attrs = attrs.replace(/[\\n\\r\\t]/g, \" \");\n      attrs = attrs.replace(/\\s+/g, \" \"); // clean up redundant spaces we just created\n      attrs = attrs.replace(/'/g, \"\\\\'\"); // escape quotes\n      virtual += `[${attrName}='${attrs}']`;\n    });\n\n    if (virtual === \"\") virtual = \"div\";\n    virtual = `\"${virtual}\"`; // add quotes\n\n    if (vnode.attrs.style) {\n      let attrs = vnode.attrs.style.replace(/(^.*);\\s*$/, \"$1\"); // trim trailing semi-colon\n      attrs = attrs.replace(/[\\n\\r]/g, \"\"); // remove newlines\n      attrs = attrs.split(/\\s*;\\s*/); // [\"color:#f00\", \"border: 1px solid red\"]\n      attrs = attrs.map((propValue) => {\n        // \"color:#f00\"\n        return propValue.split(/\\s*:\\s*/).map((part) => {\n          return `\"${part}\"`;\n        }).join(\": \"); // \"\\\"color\\\": \\\"#f00\\\"\"\n      });\n      attrs = attrs.join(\", \");\n      virtual += `, {style: {${attrs}}}`;\n    }\n\n    const children = (vnode.children.length !== 0) ?\n      new TemplateBuilder(vnode.children).complete() :\n      null;\n\n    this.children.push({\n      node: virtual,\n      children\n    });\n  },\n\n  complete: function() {\n    each(this.virtual, function(vnode) {\n      if (typeof vnode === \"string\") {\n        const trimmed = vnode.trim();\n        const charCode = trimmed.charCodeAt(0);\n        // dimiss:\n        // - empty strings\n        // - single escaped quotes\n        // - single newlines\n        // - characters with char code lower than SPACE, but allow newlines in multiline text\n        if (\n          trimmed.length !== 0\n          && trimmed !== \"\\\"\"\n          && !(trimmed.length === 1 && charCode === 10)\n          && (charCode === 10 || charCode >= 32)\n        ) {\n          this.addVirtualString(trimmed);\n        }\n      } else {\n        this.addVirtualAttrs(vnode);\n      }\n    }.bind(this));\n    return this.children;\n  }\n};\n\n/**\n * @param {number} level \n * @param {string} indent \n * @returns {string}\n */\nconst whitespace = (level, indent) => {\n  if (level < 0) return \"\";\n  let whitespace = \"\";\n  for (var i = 0; i < level; i++) {\n    whitespace += indent;\n  }\n  return whitespace;\n};\n\n/**\n * @param {string} content \n * @returns {string}\n */\nconst wrapperTemplate = content => (\n  `[${content}\\n]`\n);\n\n/**\n * @param {string} content \n * @param {string} whitespace \n * @returns {string}\n */\nconst contentTemplate = (content, whitespace) => (\n  `\\n${whitespace}${content}`\n);\n\n/**\n * @param {string} mithrilNode \n * @param {string} whitespace \n * @returns {string}\n */\nconst singleMithrilNodeTemplate = (mithrilNode, whitespace) => (\n  `\\n${whitespace}m(${mithrilNode})`\n);\n\n/**\n * @param {string} mithrilNode \n * @param {string} children \n * @param {string} whitespace \n * @param {string} indent \n * @returns {string}\n */\nconst mithrilNodeMultipleChildrenTemplate = (mithrilNode, children, whitespace, indent) => (\n  `\\n${whitespace}m(${mithrilNode},\n${whitespace}${indent}[${children}\n${whitespace}${indent}]\n${whitespace})`\n);\n\n/**\n * @param {string} mithrilNode \n * @param {string} child \n * @param {string} whitespace \n * @returns {string}\n */\nconst mithrilNodeSingleChildTemplate = (mithrilNode, child, whitespace) => (\n  `\\n${whitespace}m(${mithrilNode}, ${child}\n${whitespace})`\n);\n\n/**\n * @param {string} mithrilNode \n * @param {string} children \n * @param {string} whitespace \n * @param {string} indent \n * @returns {string}\n */\nconst template = (mithrilNode, children, whitespace, indent) => (\n  children\n    ? children.length > 1\n      ? mithrilNodeMultipleChildrenTemplate(mithrilNode, children, whitespace, indent)\n      : mithrilNodeSingleChildTemplate(mithrilNode, children, whitespace)\n    : singleMithrilNodeTemplate(mithrilNode, whitespace)\n);\n\n/**\n * @param {Array} data \n * @param {number} level \n * @param {string} indent \n */\nconst formatCode = (data, level, indent) => {\n  if (!data) {\n    return \"\";\n  }\n  return data.map((d) => {\n    const space = whitespace(level, indent);\n    if (d.content) {\n      return contentTemplate(d.content, space);\n    }\n    const node = d.node || \"\";\n    const newLevel = level + (d.children && d.children.length > 1 ? 2 : 1);\n    const children = formatCode(d.children, newLevel, indent) || \"\";\n    return template(node, children, space, indent);\n  });\n};\n\nconst indentCharsMap = {\n  \"2\": \"  \",\n  \"4\": \"    \",\n  \"tab\": \"\\t\"\n};\n\n/**\n * @param {object} opts \n * @param {string} opts.source - String containing HTML markup\n * @param {\"2\" | \"4\" | \"tab\"} opts.indent\n * @returns {string}\n */\nexport const templateBuilder = opts => {\n  const fragment = createFragment(opts.source);\n  const source = createVirtual(fragment);\n  const parsed = new TemplateBuilder(source).complete();\n  const indentLevel = parsed.length > 1 ?\n    1 :\n    0;\n  const indentChars = indentCharsMap[opts.indent || \"4\"];\n  const formatted = formatCode(parsed, indentLevel, indentChars);\n\n  // only wrap output in brackets when it is a list\n  const wrapped = formatted.length > 1 ?\n    wrapperTemplate(formatted.join(\", \")) :\n    formatted.join(\"\").trim();\n  return wrapped;\n};\n"],"names":["ENTITY_REGEX","svgCaseSensitiveTagNamesMap","each","list","f","i","length","TemplateBuilder","virtual","children","forEach","term","toLowerCase","prototype","addVirtualString","el","content","replace","contentWithEntities","split","part","match","_this","push","addVirtualAttrs","vnode","tag","attrs","class","undefined","Object","keys","sort","attrName","style","map","propValue","join","complete","node","this","trimmed","trim","charCode","charCodeAt","bind","indentCharsMap","opts","parsed","createVirtual","fragment","nodeType","nodeValue","attributes","attr","name","value","nodeName","caseTag","childNodes","markup","indexOf","DOMParser","parseFromString","container","document","createElement","insertAdjacentHTML","createFragment","source","formatted","formatCode","data","level","indent","d","space","whitespace","contentTemplate","newLevel","mithrilNode","mithrilNodeMultipleChildrenTemplate","child","mithrilNodeSingleChildTemplate","singleMithrilNodeTemplate","template"],"mappings":"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"}