{"version":3,"file":"mithril-template-builder.js","sources":["../src/index.js"],"sourcesContent":["// @ts-check\n\n/**\n * @typedef {{tag: string, attrs: object, children: Array<Vnode>}} Vnode\n */\n\n/**\n * @type {RegExp} ENTITY_REGEX\n */\nconst ENTITY_REGEX = /(&#?\\w+;)/;\nconst DEFAULT_INDENT = \"2\";\n\nconst svgCaseSensitiveTagNames = [\"altGlyph\", \"altGlyphDef\", \"altGlyphItem\", \"animateColor\", \"animateMotion\", \"animateTransform\", \"clipPath\", \"feBlend\", \"feColorMatrix\", \"feComponentTransfer\", \"feComposite\", \"feConvolveMatrix\", \"feDiffuseLighting\", \"feDisplacementMap\", \"feDistantLight\", \"feFlood\", \"feFuncA\", \"feFuncB\", \"feFuncG\", \"feFuncR\", \"feGaussianBlur\", \"feImage\", \"feMerge\", \"feMergeNode\", \"feMorphology\", \"feOffset\", \"fePointLight\", \"feSpecularLighting\", \"feSpotLight\", \"feTile\", \"feTurbulence\", \"foreignObject\", \"glyphRef\", \"linearGradient\", \"radialGradient\", \"textPath\"];\n\nconst svgCaseSensitiveTagNamesMap = {};\nsvgCaseSensitiveTagNames.forEach((term) => {\n  svgCaseSensitiveTagNamesMap[term.toLowerCase()] = term;\n});\n\n/**\n * @param {Array} list \n * @param {function} f \n */\nconst each = (list, f) => {\n  for (let i = 0; i < list.length; i++) {\n    f(list[i], i);\n  }\n};\n\n/**\n * @param {string} markup \n * @returns {Array<ChildNode>}\n */\nconst createFragment = markup => {\n  // escape HTML entities, to be resolved in addVirtualString\n  markup = markup.replace(/&/g, \"&amp;\");\n  if (markup.indexOf(\"<!doctype\") >= 0) {\n    return [\n      new DOMParser()\n        .parseFromString(markup, \"text/html\")\n        .childNodes[1]\n    ];\n  }\n  const container = document.createElement(\"div\");\n  container.insertAdjacentHTML(\"beforeend\", markup);\n  return [...container.childNodes];\n};\n\n/**\n * @param {Array<Node>|Array<ChildNode>} fragment \n * @returns {Array<Vnode>}\n */\nconst createVirtual = fragment => {\n  const list = [];\n\n  each(fragment, function(el) {\n    if (el.nodeType === 3) {\n      list.push(el.nodeValue);\n    } else if (el.nodeType === 1) {\n      const attrs = {};\n      each(el.attributes, function(attr) {\n        attrs[attr.name] = attr.value;\n      });\n\n      const tag = el.nodeName.toLowerCase();\n      const caseTag = svgCaseSensitiveTagNamesMap[tag] ? svgCaseSensitiveTagNamesMap[tag] : tag;\n\n      list.push({\n        tag: caseTag,\n        attrs,\n        children: createVirtual(el.childNodes)\n      });\n    }\n  });\n  return list;\n};\n\n/**\n * @param {string} style \n * @returns {Array<Array<string>>}\n */\nconst styleToList = style => {\n  let styleAttrs = style.replace(/(^.*);\\s*$/, \"$1\"); // trim trailing semi-colon\n  styleAttrs = styleAttrs.replace(/[\\n\\r]/g, \"\");     // remove newlines\n  const list = styleAttrs.split(/\\s*;\\s*/);           // [\"color:#f00\", \"border:1px solid red\"]\n  const styleList = list.map(propValue =>\n    propValue.split(/\\s*:\\s*/)\n  );\n  return styleList;\n};\n\n/**\n * @param {Array<Array<string>>} styleList \n * @returns {object}\n */\nconst styleListToObject = styleList => {\n  const obj = styleList.reduce((acc, [key, value]) => {\n    acc[key] = value;\n    return acc;\n  }, {});\n  return obj;\n};\n\n/**\n * \n * @param {Array<Vnode>} virtual \n * @param {object} opts\n * @param {boolean} [opts.attrsAsObject]\n */\nfunction TemplateBuilder(virtual, { attrsAsObject } = {}) {\n  this.virtual = virtual;\n  this.attrsAsObject = attrsAsObject;\n  this.children = []; // each child is an object with attributes: node, children, content\n}\n\nTemplateBuilder.prototype = {\n  addVirtualString: function(el) {\n    const content = el.replace(/([\"\\r\\n])/g, \"\\\\$1\");\n    // handle HTML entities\n    const contentWithEntities = content.split(ENTITY_REGEX);\n    if (contentWithEntities.length > 1) {\n      contentWithEntities.forEach((part) => {\n        if (part.match(ENTITY_REGEX)) {\n          this.children.push({\n            content: `m.trust(\"${part}\")`\n          });\n        } else if (part) {\n          this.children.push({\n            content: `\"${part}\"`\n          });\n        }\n      });\n    } else {\n      this.children.push({\n        content: `\"${content}\"`\n      });\n    }\n  },\n\n  /**\n   * @param {object} vnode \n   */\n  addVirtualAttrs: function(vnode) {\n\n    const template = ({ tag, className, attrsAsString, attrsAsObject, style }) => `\"${tag}${className}${attrsAsString}\"${attrsAsObject}${style}`;\n    const defaultTag = \"div\";\n\n    const data = {\n      tag: \"\",\n      className: \"\",\n      attrsAsString: \"\",\n      attrsAsObject: \"\",\n      style: \"\"\n    };\n\n    const { class: className = \"\", style = \"\", ...attrs } = vnode.attrs;\n    \n    const validAttrs = Object.keys(attrs)\n      .filter(name => attrs[name] !== undefined)\n      .reduce((obj, key) => {\n        obj[key] = attrs[key];\n        return obj;\n      }, {});\n      \n    if (!this.attrsAsObject) {\n      \n      // tag\n      data.tag = vnode.tag === defaultTag\n        ? Object.keys(validAttrs).length === 0\n          ? \"div\"\n          : \"\"\n        : vnode.tag;\n      \n      // className\n      data.className = className\n        ? `.${className.replace(/\\s+/g, \".\")}`\n        : \"\";\n\n      // attrs\n      data.attrsAsString = Object.keys(validAttrs)\n        .map(name => {\n          const value = vnode.attrs[name]\n            .replace(/[\\n\\r\\t]/g, \" \")\n            .replace(/\\s+/g, \" \")       // clean up redundant spaces we just created\n            .replace(/'/g, \"\\\\'\");      // escape quotes\n          return `[${name}='${value}']`;\n        })\n        .join(\"\");\n\n      // style\n      if (style) {\n        const styleList = styleToList(style);\n        const styleAttrs = styleListToObject(styleList);\n        const styleAttrsString = JSON.stringify(styleAttrs);\n        data.style = `, {\"style\":${styleAttrsString}}`;\n      }\n\n    } else { \n      const styleAttrs = style\n        ? styleListToObject(styleToList(style))\n        : {};\n      const withStyleAttrs = {\n        // className\n        ...(className.length > 0\n          ? { class: className }\n          : {}\n        ),\n        // attrs\n        ...attrs,\n        // style\n        ...(Object.keys(styleAttrs).length > 0\n          ? { style: styleAttrs}\n          : {}\n        )\n      };\n\n      // tag\n      data.tag = vnode.tag || defaultTag;\n\n      if (Object.keys(withStyleAttrs).length > 0) {\n        data.attrsAsObject = `, ${JSON.stringify(withStyleAttrs)}`;\n      }\n    }\n\n    const children = (vnode.children.length !== 0)\n      ? new TemplateBuilder(vnode.children, { attrsAsObject: this.attrsAsObject }).complete()\n      : null;\n\n    this.children.push({\n      node: template(data),\n      children\n    });\n  },\n\n  complete: function() {\n    each(this.virtual, function(vnode) {\n      if (typeof vnode === \"string\") {\n        const trimmed = vnode.trim();\n        const charCode = trimmed.charCodeAt(0);\n        // dimiss:\n        // - empty strings\n        // - single escaped quotes\n        // - single newlines\n        // - characters with char code lower than SPACE, but allow newlines in multiline text\n        if (\n          trimmed.length !== 0\n          && trimmed !== \"\\\"\"\n          && !(trimmed.length === 1 && charCode === 10)\n          && (charCode === 10 || charCode >= 32)\n        ) {\n          this.addVirtualString(trimmed);\n        }\n      } else {\n        this.addVirtualAttrs(vnode);\n      }\n    }.bind(this));\n    return this.children;\n  }\n};\n\n/**\n * @param {number} level \n * @param {string} indent \n * @returns {string}\n */\nconst whitespace = (level, indent) => {\n  if (level < 0) return \"\";\n  let whitespace = \"\";\n  for (var i = 0; i < level; i++) {\n    whitespace += indent;\n  }\n  return whitespace;\n};\n\n/**\n * @param {string} content \n * @returns {string}\n */\nconst wrapperTemplate = content => (\n  `[${content}\\n]`\n);\n\n/**\n * @param {string} content \n * @param {string} whitespace \n * @returns {string}\n */\nconst contentTemplate = (content, whitespace) => (\n  `\\n${whitespace}${content}`\n);\n\n/**\n * @param {string} mithrilNode \n * @param {string} whitespace \n * @returns {string}\n */\nconst singleMithrilNodeTemplate = (mithrilNode, whitespace) => (\n  `\\n${whitespace}m(${mithrilNode})`\n);\n\n/**\n * @param {string} mithrilNode \n * @param {Array<string>} children \n * @param {string} whitespace \n * @param {string} indentChars\n * @returns {string}\n */\nconst mithrilNodeMultipleChildrenTemplate = (mithrilNode, children, whitespace, indentChars) => (\n  `\\n${whitespace}m(${mithrilNode},\n${whitespace}${indentChars}[${children}\n${whitespace}${indentChars}]\n${whitespace})`\n);\n\n/**\n * @param {string} mithrilNode \n * @param {Array<string>} children \n * @param {string} whitespace \n * @returns {string}\n */\nconst mithrilNodeSingleChildTemplate = (mithrilNode, children, whitespace) => (\n  `\\n${whitespace}m(${mithrilNode}, ${children}\n${whitespace})`\n);\n\n/**\n * @param {string} mithrilNode \n * @param {Array<string>} children \n * @param {string} whitespace \n * @param {string} indentChars\n * @returns {string}\n */\nconst template = (mithrilNode, children, whitespace, indentChars) => (\n  children\n    ? children.length > 1\n      ? mithrilNodeMultipleChildrenTemplate(mithrilNode, children, whitespace, indentChars)\n      : mithrilNodeSingleChildTemplate(mithrilNode, children, whitespace)\n    : singleMithrilNodeTemplate(mithrilNode, whitespace)\n);\n\n/**\n * @param {Array} data \n * @param {number} level \n * @param {string} indentChars\n * @returns {Array<string>}\n */\nconst formatCode = (data, level, indentChars) => {\n  if (!data) {\n    return;\n  }\n  return data.map((d) => {\n    const space = whitespace(level, indentChars);\n    if (d.content) {\n      return contentTemplate(d.content, space);\n    }\n    const node = d.node || \"\";\n    const newLevel = level + (d.children && d.children.length > 1 ? 2 : 1);\n    const children = formatCode(d.children, newLevel, indentChars);\n    return template(node, children, space, indentChars);\n  });\n};\n\nconst indentCharsMap = {\n  \"2\": \"  \",\n  \"4\": \"    \",\n  \"tab\": \"\\t\"\n};\n\n/**\n * @param {object} opts \n * @param {string} opts.source - String containing HTML markup\n * @param {(\"2\" | \"4\" | \"tab\")} [opts.indent]\n * @param {boolean} [opts.attrsAsObject]\n * @returns {string}\n */\nconst templateBuilder = opts => {\n  const fragment = createFragment(opts.source);\n  const source = createVirtual(fragment);\n  const parsed = new TemplateBuilder(source, { attrsAsObject: opts.attrsAsObject }).complete();\n  const indentLevel = parsed.length > 1 ?\n    1 :\n    0;\n  const indentChars = indentCharsMap[opts.indent || DEFAULT_INDENT];\n  const formatted = formatCode(parsed, indentLevel, indentChars);\n\n  // only wrap output in brackets when it is a list\n  const wrapped = formatted.length > 1 ?\n    wrapperTemplate(formatted.join(\", \")) :\n    formatted.join(\"\").trim();\n  return wrapped;\n};\n\nexport default templateBuilder;\n"],"names":["ENTITY_REGEX","svgCaseSensitiveTagNamesMap","forEach","term","toLowerCase","each","list","f","i","length","styleToList","style","styleAttrs","replace","split","map","propValue","styleListToObject","styleList","reduce","acc","key","value","TemplateBuilder","virtual","attrsAsObject","children","prototype","addVirtualString","el","content","contentWithEntities","part","match","_this","push","addVirtualAttrs","vnode","data","tag","className","attrsAsString","attrs","class","validAttrs","Object","keys","filter","name","undefined","obj","this","withStyleAttrs","JSON","stringify","join","styleAttrsString","complete","node","template","trimmed","trim","charCode","charCodeAt","bind","indentCharsMap","opts","parsed","createVirtual","fragment","nodeType","nodeValue","attributes","attr","nodeName","caseTag","childNodes","markup","indexOf","DOMParser","parseFromString","container","document","createElement","insertAdjacentHTML","createFragment","source","formatted","formatCode","level","indentChars","d","space","indent","whitespace","contentTemplate","newLevel","mithrilNode","mithrilNodeMultipleChildrenTemplate","mithrilNodeSingleChildTemplate","singleMithrilNodeTemplate"],"mappings":"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"}